<script>
  mergeInto(LibraryManager.library, {
    SendEmailViaJS: function (recipientPtr, messagePtr, namePtr, scorePtr, imageBase64Ptr) {
      if (typeof emailjs === 'undefined' || !window.emailjsReady) {
        console.error("‚ùå EmailJS is not ready.");
        return;
      }

      const recipient = UTF8ToString(recipientPtr);
      const message = UTF8ToString(messagePtr);
      const name = UTF8ToString(namePtr);
      const score = UTF8ToString(scorePtr);
      const base64 = UTF8ToString(imageBase64Ptr);

      console.log("üì§ Uploading selfie to Imgur...");

      fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: {
          Authorization: 'Client-ID a21f776f6b3fe85', // ‚úÖ Replace with your actual Client ID
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          image: base64,
          type: 'base64',
        }),
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success || !data.data.link) {
          throw new Error("Imgur upload failed");
        }

        const imageUrl = data.data.link;
        console.log("‚úÖ Uploaded to Imgur:", imageUrl);

        return emailjs.send('service_0x00k3y', 'template_ph5qn3g', {
          email: recipient,
          name: name,
          score: score,
          message: message,
          image_url: imageUrl,
        }, 'JCfEnadXLBXD3_Ds8');
      })
      .then(response => {
        console.log("‚úÖ EmailJS success:", response.status);
        unityInstance.SendMessage('EndGameMenu', 'NotifyUser', 'Email sent successfully!');
      })
      .catch(error => {
        console.error("‚ùå Error sending email or uploading:", error);
        unityInstance.SendMessage('EndGameMenu', 'NotifyUser', 'Failed to send email.');
      });
    }
  });
</script>
